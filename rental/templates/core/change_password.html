{% extends 'base.html' %}

{% block title %}Смена пароля{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-warning text-dark text-center py-4">
                    <h3><i class="bi bi-shield-lock"></i> Смена пароля</h3>
                    <p class="mb-0">Защитите свой аккаунт новым надежным паролем</p>
                </div>
                <div class="card-body p-4 p-md-5">
                    <form method="post" novalidate>
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            <label for="{{ form.old_password.id_for_label }}" class="form-label">
                                <i class="bi bi-key"></i> Текущий пароль
                            </label>
                            {{ form.old_password }}
                            {% if form.old_password.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.old_password.errors }}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-4">
                            <label for="{{ form.new_password1.id_for_label }}" class="form-label">
                                <i class="bi bi-key-fill"></i> Новый пароль
                            </label>
                            {{ form.new_password1 }}
                            {% if form.new_password1.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.new_password1.errors }}
                            </div>
                            {% endif %}
                            <div class="mt-2">
                                <div class="password-strength">
                                    <div class="progress" style="height: 5px;">
                                        <div class="progress-bar" id="passwordStrengthBar" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted" id="passwordStrengthText">Надежность пароля</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="{{ form.new_password2.id_for_label }}" class="form-label">
                                <i class="bi bi-key-fill"></i> Подтвердите новый пароль
                            </label>
                            {{ form.new_password2 }}
                            {% if form.new_password2.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.new_password2.errors }}
                            </div>
                            {% endif %}
                            <div class="mt-2" id="passwordMatch"></div>
                        </div>

                        <!-- Требования к паролю -->
                        <div class="alert alert-info">
                            <h6 class="alert-heading">Рекомендации для надежного пароля:</h6>
                            <ul class="mb-0">
                                <li id="lengthCheck">Не менее 8 символов</li>
                                <li id="uppercaseCheck">Содержит заглавные буквы</li>
                                <li id="lowercaseCheck">Содержит строчные буквы</li>
                                <li id="numberCheck">Содержит цифры</li>
                                <li id="specialCheck">Содержит специальные символы (!@#$%^&*)</li>
                            </ul>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-warning btn-lg">
                                <i class="bi bi-check-circle"></i> Изменить пароль
                            </button>
                            <a href="{% url 'edit_profile' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Назад к профилю
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .password-strength {
        margin-top: 0.5rem;
    }

    .progress {
        background-color: #e9ecef;
        border-radius: 3px;
    }

    .progress-bar {
        transition: width 0.3s ease;
        border-radius: 3px;
    }

    .requirement-met {
        color: #28a745;
        font-weight: 500;
    }

    .requirement-not-met {
        color: #6c757d;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const newPassword1 = document.querySelector('#{{ form.new_password1.id_for_label }}');
        const newPassword2 = document.querySelector('#{{ form.new_password2.id_for_label }}');
        const strengthBar = document.querySelector('#passwordStrengthBar');
        const strengthText = document.querySelector('#passwordStrengthText');
        const passwordMatch = document.querySelector('#passwordMatch');

        const requirements = {
            lengthCheck: document.querySelector('#lengthCheck'),
            uppercaseCheck: document.querySelector('#uppercaseCheck'),
            lowercaseCheck: document.querySelector('#lowercaseCheck'),
            numberCheck: document.querySelector('#numberCheck'),
            specialCheck: document.querySelector('#specialCheck')
        };

        function checkPasswordStrength(password) {
            let score = 0;

            // Длина
            if (password.length >= 8) {
                score += 25;
                requirements.lengthCheck.classList.add('requirement-met');
                requirements.lengthCheck.classList.remove('requirement-not-met');
            } else {
                requirements.lengthCheck.classList.remove('requirement-met');
                requirements.lengthCheck.classList.add('requirement-not-met');
            }

            // Заглавные буквы
            if (/[A-Z]/.test(password)) {
                score += 25;
                requirements.uppercaseCheck.classList.add('requirement-met');
                requirements.uppercaseCheck.classList.remove('requirement-not-met');
            } else {
                requirements.uppercaseCheck.classList.remove('requirement-met');
                requirements.uppercaseCheck.classList.add('requirement-not-met');
            }

            // Строчные буквы
            if (/[a-z]/.test(password)) {
                score += 25;
                requirements.lowercaseCheck.classList.add('requirement-met');
                requirements.lowercaseCheck.classList.remove('requirement-not-met');
            } else {
                requirements.lowercaseCheck.classList.remove('requirement-met');
                requirements.lowercaseCheck.classList.add('requirement-not-met');
            }

            // Цифры и специальные символы
            if (/\d/.test(password)) {
                score += 12.5;
                requirements.numberCheck.classList.add('requirement-met');
                requirements.numberCheck.classList.remove('requirement-not-met');
            } else {
                requirements.numberCheck.classList.remove('requirement-met');
                requirements.numberCheck.classList.add('requirement-not-met');
            }

            if (/[!@#$%^&*]/.test(password)) {
                score += 12.5;
                requirements.specialCheck.classList.add('requirement-met');
                requirements.specialCheck.classList.remove('requirement-not-met');
            } else {
                requirements.specialCheck.classList.remove('requirement-met');
                requirements.specialCheck.classList.add('requirement-not-met');
            }

            // Обновляем прогресс бар
            strengthBar.style.width = score + '%';

            // Устанавливаем цвет и текст
            if (score < 30) {
                strengthBar.className = 'progress-bar bg-danger';
                strengthText.textContent = 'Слабый пароль';
                strengthText.className = 'text-danger';
            } else if (score < 70) {
                strengthBar.className = 'progress-bar bg-warning';
                strengthText.textContent = 'Средний пароль';
                strengthText.className = 'text-warning';
            } else if (score < 90) {
                strengthBar.className = 'progress-bar bg-info';
                strengthText.textContent = 'Хороший пароль';
                strengthText.className = 'text-info';
            } else {
                strengthBar.className = 'progress-bar bg-success';
                strengthText.textContent = 'Отличный пароль';
                strengthText.className = 'text-success';
            }
        }

        function checkPasswordMatch() {
            const password1 = newPassword1.value;
            const password2 = newPassword2.value;

            if (password2 === '') {
                passwordMatch.innerHTML = '';
                return;
            }

            if (password1 === password2) {
                passwordMatch.innerHTML = '<small class="text-success"><i class="bi bi-check-circle"></i> Пароли совпадают</small>';
            } else {
                passwordMatch.innerHTML = '<small class="text-danger"><i class="bi bi-x-circle"></i> Пароли не совпадают</small>';
            }
        }

        newPassword1.addEventListener('input', function() {
            checkPasswordStrength(this.value);
            checkPasswordMatch();
        });

        newPassword2.addEventListener('input', checkPasswordMatch);

        // Инициализация
        checkPasswordStrength('');
    });
</script>
{% endblock %}